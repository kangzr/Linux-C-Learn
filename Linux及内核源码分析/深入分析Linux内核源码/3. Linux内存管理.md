#### 概述

Linux内存管理主要体现在对虚拟内存的管理，概括为以下几点：

- 大地址空间
- 进程保护
- 内存映射
- 公平的物理内存分配
- 共享虚拟内存

![linux_vm_arch](..\..\pic\linux_vm_arch.png)

大部分源代码在`/mm`目录下：

- 内存映射模块(mmap)：负责把磁盘文件的逻辑地址映射到虚拟地址，以及把虚拟地址到物理地址
- 交换模块(swap)：负责控制内存内容的换入换出，它通过交换机制，使得在物理内存的页面（RAM页）中保留有效页，即从主存中淘汰最近没有被访问的页，保存进来访问过的页。
- 核心内存管理模块(core)：负责核心内存管理功能，即对页的分配、回收、释放以及请求页处理等，这些功能将被别的内核子系统(文件系统)使用
- 结构特定的模块：负责给各种硬件平台提供通用接口，这个模块通过执行命令来改变硬件MMU的虚拟地址映射，并在发生页错误时，提供公用方法通知别的内核子系统，这个模块是实现虚拟内存的物理基础。

虚拟地址空间为0~4G字节，被分成两部分，内核空间(0xC0000000 ~ 0xFFFFFFFF)；用户空间3G(0x00000000~0xBFFFFFFF)。

内核空间存放内核代码和数据，进程用户空间存放用户代码和数据，不管内核空间还是用户空间，都处于虚拟空间中。

![linux_virtual_memory](..\..\pic\linux_virtual_memory.png)

虽然内核空间占据每个虚拟空间中的最高1G字节，但映射到物理内存却总是从最低地址(0x00000000)开始。且为简单的线性映射

![linux_vm_pm](..\..\pic\linux_vm_pm.png)

![linux_kernel_in_m](..\..\pic\linux_kernel_in_m.png)

内核的代码数据就叫内核映像，系统启动时，Linux内存映像被安装在物理地址0x00100000开始的地方，即1MB开始的区间（第1M留作他用）；

整个内核映射应该在虚拟内核空间中；

#### 虚拟内存实现机制间的关系

围绕以下几个机制进行介绍：

- 内存分配和回收机制

- 地址映射机制

- 缓存和刷新机制

- 请页机制

- 交换机制

- 内存共享机制

  ![linux_vm_relation](..\..\pic\linux_vm_relation.png)



##### Linux内存管理初始化



##### 内存分配和回收

Slab分配模式把对象分组放进缓冲区，

![linux_slab](..\..\pic\linux_slab.png)



##### 请页机制避免对物理内存的过分使用

![linux_kernel_process_addr](..\..\pic\linux_kernel_process_addr.png)



#### 进程的创建和执行

写时复制：只有当两个进程中的任意一个向虚拟内存中写入数据时才复制相应的虚拟内存，而没有写入的任何内存页均可在两个进程之间共享。代码页实际可以共享的。

```c
// kernel/fork.c
int do_fork() {
    
}
```











