#### Android进程内存空间

32位操作系统中，进程的地址空间位0到4GB

![andriod_mem](..\pic\andriod_mem.png)

stack空间由系统操作，主要存储函数地址，参数，局部变量等，所以stack空间不需要很大，一般位几M大小

heap空间由程序员控制，可使用malloc，new，free，delete等函数调用来操作这块地址，一般为几百M到几GB。

##### OOM Killer

机器上的内存可能会被耗尽，并且内核被无法回收足够的内存用于运行新的程序，内核会调用ＯＯＭ　Ｋｉｌｌｅｒ杀掉一些进程，以释放内存

##### Andriod中的进程

Native进程：采用c/C++实现，不包含Dalvik实例的LInux进程

Java进程：实例化了Dalvik虚拟机实例的Linux进程，进程入口main函数为java函数。Dalvik虚拟机实例的宿主进程时fork系统调用创建的LInux进程，每个Andriod上的Java进程实际是一个LInux进程，只是进程中多了一个Dalvik虚拟机实例。Andriod系统中的应用程序基本都是Java进程。

Q：Andriod的Java程序为什么容易出现OOM？

A：因为Andriod系统堆Dalvik的VM HeapSize做了硬性限制，当java进程申请的java空间超过阈值时，就会抛出OOM，这样设计的目的是为了让比较多的进程常驻内存，这样程序启动时就不用每次都重新加载到内存，能够给用户更快的响应。

andriod最初时linux的一个分支，andriod是在linux内核基础之上运行，提供的核心系统服务包括安全、内存管理、进程管理、组网组和驱动模块等内容。

##### Andriod内存管理机制

**分配机制：**

为每一个进程分配一个合理大小的内存块，保证每个进程能够正常运行，同时确保进程不会占用太多的内存；Andriod系统需要最大限度的让更多进程存活在内存中，以保证用户再次打开应用时减少应用的启动时间，提高用户体验。

**回收机制：**

当系统内存不足时，需要一个合理的回收再分配机制，以保证新的进程可以正常运行。回收时杀死那些正在占用内存的进程，OS需要提供一个合理的杀死进程机制。

同样作为一个多任务操作系统，Andriod系统对内存管理有一套自己的方法，手机上内存资源比pc更少，需要更加谨慎的管理内存。理解Andriod内存分配机制有助于我们写出更高效的代码，提高应用性能。

