网络穿透（打洞，穿透网关） P2P 去中心化网络



**局域网内部 如何将数据发送到 公网服务器？以及服务器如何到客户端**

NAT (Network Address Tranform)：网络地址映射

IP地址+端口 映射到 子网上的某台机器的某个进程



每一个网关都有一个NAT映射表



虚拟机网络三种模式：

1. 桥接模式：物理机和虚拟机的ip地址在同一个网段（网关）
2. NAT模式：把物理机当作网关，虚拟机是物理机子网虚拟出来的网络
3. 仅主机模式host only: 虚拟机仅允许物理机访问



WHY NAT？

因为ipv4的地址不足

   ipv6每台机器都有一个地址，就不需要网络穿透



网络穿透：

直接向网关的IP和端口发数据，不需要经过公网服务器;(两个客户端直接发送数据)



`netstat -anop | grep port`



1. 既然两个客户端可以直接通信，为何要先启动服务器？
   - 帮助找到对方的网关ip地址和端口

2. 为什么要用udp？tcp是否可以？
   - udp不需要建立连接，实现比较简单



快播技术：去中心化，内容不可控。

快播不存储资源，只告诉你资源在哪个服务器上；找到之后，就没有快播服务器什么事了。

bt：唯一id，可以通过bt找到资源



区块链技术：政府不允许监控不到的东西存在





并不是所有的网关都可以被穿透。跟网关的NAT类型有关。



![image-20201010211407825](C:\Users\kangzhongrun\AppData\Roaming\Typora\typora-user-images\image-20201010211407825.png)

互补关系，类型由生产路由器的厂家决定，根据安全级别

- 完全锥形NAT：无限制，可直接穿透
- 限制锥形NAT：只允许部分{IP: port}通过；在NAT表（fromip(一样) destip(不一样) localip一样）中**只生成了一条记录**（限制外面发进来）
- 对称NAT：每一个IP地址映射一个端口；两条记录；（不知道生成的端口是什么）





NAT表 fromip(一样) destip(不一样) localip  （三个字段的含义）

![image-20201010213143223](C:\Users\kangzhongrun\AppData\Roaming\Typora\typora-user-images\image-20201010213143223.png)



**如何检测网关NAT类型？**

给不同IP地址发数据，判断收到回复的地址



所有客户端网关类型由服务器集中存储。



**如何做穿透**

NAT类型组合：

- 一端为完全锥形NAT
- 两边都是限制锥形NAT
- 两边是对称NAT, 或者一个是限制NAT与对称NAT