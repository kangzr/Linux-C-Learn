##### 进程内存空间分布图

![process_mm](..\pic\process_mm.png)

- 程序段(Text)：程序代码在内存中的映射，存放函数体的二进制代码
- 初始化过的数据Data：在程序运行初对变量进行初始化的数据，全局变量，静态变量(static int a;)
- 未初始化的数据BSS：在程序运行初未对变量初始化的数据，全局变量，静态变量（static int a = 0;）
- 堆heap：存储动态内存分配，需要手动分配和释放，区别与数据结构堆，分配方式类似于链表
- 栈stack：存储局部、临时变量，函数调用时，存储函数的返回指针，用于控制函数的调用和返回，在程序块开始时自动分配内存，结束时自动释放。



##### 进程内存（物理内存于虚拟内存）

32位系统，为进程分配4G虚拟内存（0~3G为用户空间，3G~4G为内核空间），并映射到物理内存上，且所有的进程共享一块物理内存。

用户程序使用的都是虚拟内存中的地址，永远无法直接访问实际物理内存

虚拟内存到物理内存的映射由操作系统动态维护

虚拟内存一方面保护了操作系统的安全，另一方面允许应用程序使用比实际物理内存更大的地址空间

用户空间中的代码不能直接访问内核空间中的代码和数据，但可以通过系统调用进入内核态。

当不同的进程使用同一段代码时，比如库文件代码，物理内存中只存一份代码，不同进程将自己的虚拟内存映射过去就好，可节省物理内存。

在程序分配连续内存空间时，只需要在虚拟内存分配连续空间，而物理内存都是断断续续的内存碎片。



##### 进程和程序的区别：

- 程序是指令的有序集合，是一个静态的概念；而进程是程序的一次执行过程，是一个动态的概念

- 程序需是长期存在的，进程具有一定生命周期。 进程=程序+数据+进程控制块



##### 进程和线程的区别：

- 一个线程只能属于一个进程，一个进程可以拥有多个线程，多线程处理就是进程在同一时刻执行多个任务
- 线程是一种轻量级进程，与进程相比，线程的代价或开销更小
- 线程没有地址空间，线程包含在进程的地址空间中。线程上下文只包含**一个堆栈、一个寄存器、一个优先权**；进程拥有的所有资源都属于线程，所有线程共享进程的内存和资源
- 同一进程中的多个线程共享代码段(代码和常量)，数据段(全局变量和静态变量)，堆存储。**但每个线程拥有自己的栈段，寄存器内容，栈段又叫运行时段**，用来存放所有局部变量和临时变量
- 父子进程间使用进程间通信机制，同一进程的线程通过读取和写入数据到进程变量来通信，线程间通信更方便。
- 进程内的任何线程都被看做是同位体，处相同级别。进程内任何线程都可以销毁、挂起、恢复或更改其他线程的优先权，进程中任何线程都可以通过销毁主线程来销毁进程。所以多进程程序更加健壮，多线程程序只要有一个线程死掉，整个进程也死掉了，而一个进程死掉并不会对另外一进程造成影响，因为进程有自己独立的地址空间。



##### 每个线程独立的栈有多大？

默认线程栈是8M



##### 进程间通信

- 管道pipe
- 有名管道FIFO
- 消息队列Message Queue
- 共享内存（最快），分为存储映射IO(mmap)，shgmet函数；mmap：将磁盘文件映射到进程空间（内存），返回内存首地址
- 信号量Semphore
- 信号signal
- socket套接字



##### 内存申请的系统调用

brk和mmap

- brk系统调用增加heap顶部的brk值来线性增加进程的heap空间
- mmap系统调用从堆和栈的中间分配一块虚拟内存
- brk分配内存需要等到高地址内存释放后才释放，mmap分配的内存可以单独释放
- malloc内存通过brk或mmap系统调用向内核申请堆空间

![process_virtual_m](..\pic\process_virtual_m.png)











