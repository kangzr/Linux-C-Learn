### MySQL

视图

存储过程

触发器

定时器：定期备份



#### MySQL事务

**MySQL中只有使用Innodb引擎的数据库或表才支持事务**



**每一个事务都有一个undolog（临时表），用来记录临时数据（指令），undolog中所有的事务执行成功才返回，有一个失败了，则所有的都不执行。**



**原子性**：一个事务(transaction)中的所有操作，要么全部完成，要么全部不完成，不会结束在中间某个环节。事务在执行过程中发生错误，会被回滚Rollback到事务开始前的状态，就像这个事务从来没有执行过一样

**一致性**：在事务开始前和事务结束后，数据库的完整性没有被破坏。

**隔离性**：数据库允许多个并发事务同时对其数据进行读写和修改的能力，隔离性可以防止多个事务并发执行时由于交叉执行而导致数据的不一致。事务隔离分为不同级别，包括读未提交，读已提交(不可重复读)，可重复读（Mysql默认隔离级别），串行化。

**持久性**：事务处理结束后，对数据的修改就是永久的，即使系统故障也不会丢失。

![mysql_is](..\pic\mysql_is.png)



**脏读**：事务A读到事务B未提交的数据。（数据值为100， b修改为200，a查询为200，b回滚，a增加100 == 300，a提交这时候数据为300，本来应该为200）

**不可重复读**：事务A中先后两次取同一数据，两次读取结果不一样。区别脏读：一个读到已提交事务，另一个读到未提交事务。

**幻读**：事务A中按照某个条件先后两次查询数据库，两次查询结果的条数不同。区别不可重复读： 一个数据变了，一个数据的行数变了。

**不可重复读和幻读区别**

**不可重复读**是读取了其它事务更改的数据（update操作），解决办法：使用**行级锁**，锁定改行，事务多次读取操作完成后才释放锁。

**幻读**是读取了其它事务新增的数据，针对insert和delete操作，解决办法：使用**表级锁**，锁定整张表，事务A多次读取数据总量后才释放。





#### MySQL存储引擎

`show engines`

MySQL中的锁：（从上往下，并发度逐渐降低，锁粒度逐渐增大）

- **行级锁**：粒度最细的一种锁，只针对当前操作的行进行加锁。分为共享锁和排他锁。

  特点：加锁开销大，会出现死锁，粒度最小，发生锁冲突概率最低，并发度最高。

- **页级锁**：锁粒度介于行级锁和表级锁之间，采取折衷方案，一次锁定相邻的一组记录。BDB支持（数据在磁盘是一页一页存储的）

  特点：开销和加锁时间界于表锁和行锁之间，会出现死锁；并发度一般

- **表级锁**：粒度最大的一种锁，表示对当前操作的整张表加锁，实现简单，资源消耗较少，被大部分MySQL引擎支持。分为：共享锁和排他锁。

  特点：开销小，加锁快，不会出现死锁，锁定粒度大，发出锁冲突的概率最高，并发度最低。

##### MyISAM存储引擎

不支持事务（**因为只有表级锁，不支持行级锁**）、不支持外键，因此访问速度较快。因此当对事务完整性没有要求并以访问为主的应用适合使用该存储引擎。

MyISAM存储引擎索引文件和数据文件是分离的，表相关文件有三个：`.frm`存放表结构数据，`MYD`是表数据，`MYI`是存放索引。



**使用B树作为索引结构，叶子节点的data域存放数据记录的地址。MyISAM中索引检索算法为首先按照B+Tree搜索算法搜索索引，如果key存在，则取出data域的值，然后以data域的值为地址，读取相应数据记录。MyISAM索引文件和数据文件分离，索引文件仅保存数据记录的地址。**



主要特征：

##### InnoDB存储引擎

支持事务（**有行级锁**）

**MVCC实现原理，解决了什么问题？**

undolog来实现并发（临时表），同时对一个事务进行执行



mysql5.5以后默认引擎

由于该存储引擎在事务上具有优势，即支持具有提交，回滚及崩溃恢复能力等事务特性，比MyISAM占用更多的磁盘空间。因此当需要频繁的更新、删除操作时，同时还对事务完整性要求较高，需要实现并发控制，可选择。



表数据文件本身就是按B+Tree组织的一个索引结构文件，主键索引叶节点包含了完整的数据记录，表相关文件只有两个：`.frm`文件存放表结构数据，`.ibd`存放数据和索引。

InnoDB是事务型数据库的首选引擎，是目前最重要、使用最广泛的存储引擎。支持事务安全表(ACID)，支持行锁定和外键



**InnoDB中，表数据文件（数据和索引放一块）本身就是按B+Tree组织的一个索引结构，这棵树的叶节点data域保存了完整的数据记录，这个索引的key是数据表的主键，因此，InnoDB表数据文件本身也就是索引。**



主要特点：



##### MERGE引擎

一组MyISAM表的组合。

##### MEMORY存储引擎

将表的数据存储在内存中，为查询和引用其它表数据提供快速访问。





**为什么MyISAM不支持事务，InnoDB支持？**

因为MyISAM只有表级锁，不支持行级锁。而InnoDB支持行级锁。



**MyISAM和InnoDB如何存储数据？**

table中有10000w条数据，在mysql中如何存储？



数据查找时，MyISAM直接把整棵B+树加载到内存中，每个数据都要到磁盘去取，查询数据量很小的情况，MyISAM可能比较快。（B+叶子节点存的是数据地址）

InnoDB是提前预知把B+树部分加载到内存中，因为整个加载会占用太大内存（B+叶子节点存的是数据），性能会非常差。



这也是InnoDB不支持全文索引，而MyISAM支持。





##### binlog

MySQL WorkBench 和数据库之间通过网络连接，接口3306（连接器），sql解析，解析完优化，优化完执行（所有这些都是内存操作），执行成功一条会生成一条执行记录，这个执行记录就是在binlog（主要用于记录，主要存储所有执行过的语句）（select * from teacher在binlog中不会记录，只有涉及到数据变更才会记录）

binlog有什么用？

回滚rollback，（如何作回滚：比如要回滚到昨天，就要把数据恢复到前天，在执行前天到昨天的binlog记录）

主从模式也需要用来binlog：（master主动通知slave）

relay log 是binlog备份还是增量？

**增量**













