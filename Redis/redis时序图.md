#### 时序图

the process to accept a redis client connection

the process to receive the data of command and handle the command,but not include sending the response to client

the process to repsonse client



Redis提供两种基本事件：FileEvent和TimeEvent。前者基于OS的异步机制(epoll)实现的文件事件，后者Redis自己实现的定时器



 Redis在处理请求时完全

是用单线程异步模式，通过epoll监听所有连接的读写事件，并通过相应的响应函数处理。Redis使用这样的设计来满足需求，很大程度上因为它服务的是高并发的短连接，且请求处理事件非常短暂。这个模型下，一旦有请求阻塞了服务，整个Redis的服务将受影响。Redis采用单线程模型可以避免系统上下文切换的开销。



##### 单线程模型

 Redis客户端对服务端的每次调用都经历了发送命令，执行命令，返回结果三个过程。其中执行命令阶段，由于Redis是单线程来处理命令的，所以每一条到达服务端的命令不会立刻执行，所有的命令都会进入一个队列中，然后逐个被执行。并且多个客户端发送的命令的执行顺序是不确定的。但是可以确定的是不会有两条命令被同时执行，不会产生并发问题，这就是Redis的单线程基本模型。

##### 单线程模型每秒万级别处理能力的原因

- 纯内存访问。数据存放在内存中，内存的响应时间大约是100纳秒，这是Redis每秒万亿级别访问的重要基础。
- 非阻塞I/O，Redis采用epoll做为I/O多路复用技术的实现，再加上Redis自身的事件处理模型将epoll中的连接，读写，关闭都转换为了时间，不在I/O上浪费过多的时间。
- 单线程避免了线程切换和竞态产生的消耗。
- Redis采用单线程模型，每条命令执行如果占用大量时间，会造成其他线程阻塞，对于Redis这种高性能服务是致命的，所以Redis是面向高速执行的数据库



Redis多线程执行

 网络IO事件的处理要顺序处理，读IO可以多线程一次性读到队列中，读满为止；网络IO事件的处理要按顺序处理，网络IO写事件可以多线程同时操作

redis6.0引入了多线程IO：多线程读取/写入，单线程执行命令

- 主线程接收客户端并创建连接，注册读事件，读事件就绪，主线程将读事件放到一个队列

- 主线程利用RR策略，将读事件分配给多个IO线程，然后主线程开始等待IO线程读取数据到缓冲区，并解析命令

- 主线程忙等待结束，单线程执行解析后的命令，将响应写入输出缓冲区

- 返回响应时，主线程RR，将写事件分配给多个IO线程，然后主线程忙等待

  





#### 三种集群方式

[cluster](https://blog.csdn.net/alpha_love/article/details/107426087)

##### 主从复制

1. 从服务器连接主服务器，发送SYNC（同步）命令；
2. 主服务器接收到SYNC命名后，开始执行BGSAVE命令生成RDB文件并使用缓冲区记录此后执行的所有写命令；
3. 主服务器BGSAVE执行完后，向所有从服务器发送快照文件，并在发送期间继续记录被执行的写命令；
4. 从服务器收到快照文件后丢弃所有旧数据，载入收到的快照；
5. 主服务器快照发送完毕后开始向从服务器发送缓冲区中的写命令；
6. 从服务器完成对快照的载入，开始接收命令请求，并执行来自主服务器缓冲区的写命令；（从服务器初始化完成）
7. 主服务器每执行一个写命令就会向从服务器发送相同的写命令，从服务器接收并执行收到的写命令（从服务器初始化完成后的操作）

**优点**

1. 支持主从复制，主机会自动将数据同步到从机，可以进行读写分离
2. 为了分载Master的读操作压力，Slave服务器可以为客户端提供只读操作的服务，写服务仍然必须由Master来完成
3. Slave同样可以接受其它Slaves的连接和同步请求，这样可以有效的分载Master的同步压力。
4. Master Server是以非阻塞的方式为Slaves提供服务。所以在Master-Slave同步期间，客户端仍然可以提交查询或修改请求。
5. Slave Server同样是以非阻塞的方式完成数据同步。在同步期间，如果有客户端提交查询请求，Redis则返回同步之前的数据

**缺点**

1. Redis不具备自动容错和恢复功能，主机从机的宕机都会导致前端部分读写请求失败，需要等待机器重启或者手动切换前端的IP才能恢复。
2. 主机宕机，宕机前有部分数据未能及时同步到从机，切换IP后还会引入数据不一致的问题，降低了系统的可用性。
3. Redis较难支持在线扩容，在集群容量达到上限时在线扩容会变得很复杂。



##### 哨兵模式

##### Redis-Cluster集群

